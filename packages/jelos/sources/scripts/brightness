#!/bin/bash
# SPDX-License-Identifier: GPL-2.0-or-later
# Copyright (C) 2020-present Fewtarius

## Load minimal distribution settings to improve
## performance.
. /etc/profile.d/001-functions

BRIGHTNESS_DEV="$(find /sys/class/backlight/*/ -name brightness -print -quit)"
BRIGHTNESS_PATH="${BRIGHTNESS_DEV%/brightness}"

MIN=0
MAX=$(<$(find /sys/class/backlight/*/ -name max_brightness -print -quit))
NUM_STEPS=10
eqn() {
  echo "(l(1.0+$NUM_STEPS-$NEXT)/l(1.0+$NUM_STEPS))"
}
compute() {
  echo "x=$MAX+0.5-(($MAX-$MIN)*$(eqn$1)); scale=0; x/1" | bc -l
}

if [ ! -f "${BRIGHTNESS_DEV}" ]
then
  echo "ERROR: There is no BRIGHTNESS object to manage."
  exit 1
fi

getBrightness() {
  echo $(<${BRIGHTNESS_DEV})
}

setBrightness() {
  echo "${1}" > ${BRIGHTNESS_DEV}
  set_setting system.brightness "${2}"
}

stepUp() {
  CURRENT=$(get_setting system.brightness)
  NEXT=$(( ${CURRENT} + 1 ))
  if (( ${NEXT} > 10 ))
  then
    NEXT=10
  fi

  BRIGHTNESS=$(printf '%.0f' "$(compute)")

  setBrightness ${BRIGHTNESS} ${NEXT}
}

stepDown() {
  CURRENT=$(get_setting system.brightness)
  NEXT=$(( ${CURRENT} - 1 ))
  if (( ${NEXT} < 0 ))
  then
    NEXT=0
  fi

  BRIGHTNESS=$(printf '%.0f' "$(compute)")

  setBrightness ${BRIGHTNESS} ${NEXT}
}

case ${1} in
        "up")
          stepUp
        ;;
        "down")
          stepDown
        ;;
        "device")
          echo ${BRIGHTNESS_DEV}
        ;;
        "path")
          echo ${BRIGHTNESS_PATH}
        ;;
        "set")
          NEXT=${2}
           setBrightness "$(printf '%.0f' "$(compute)")" ${2}
        ;;
        *)
          echo $(getBrightness)
        ;;
esac
