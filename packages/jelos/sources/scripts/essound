#!/bin/bash
# SPDX-License-Identifier: Apache-2.0
# Copyright (C) 2020 Fewtarius (https://github.com/fewtarius)

. /etc/profile

ES_SETTINGS="/storage/.config/emulationstation/es_settings.cfg"

get_controls() {
  IFS=""
  CONTROLS=$(amixer controls | sed -e 's#^.*name=##g' -e "s#'##g")

  for CONTROL in "${CONTROLS[@]}"
  do
    echo ${CONTROL} | awk '{print $1}' | grep -v -E 'Mic|Extension|Capture|Differential|Left|Right' | uniq
  done
  echo "--------"
  for CONTROL in "${CONTROLS[@]}"
  do
    echo ${CONTROL}
  done
}

get_es() {
  AUDIODEVICE=$(grep AudioDevice ${ES_SETTINGS} | sed -e 's#^.*="##g' -e 's#"\ .*$##g')
  if [ -z "${AUDIODEVICE}" ]
  then
    echo "DEFAULT"
  else
    echo "${AUDIODEVICE}"
  fi
}

set_es() {
  AUDIODEVICE=${1}
  AUDIOTEST=$(grep "AudioDevice" ${ES_SETTINGS} 2>/dev/null)
  sed -i '/<string name="AudioDevice".*$/d' ${ES_SETTINGS}
  if [ ! "${AUDIODEVICE}" = "DEFAULT" ]
  then
    sed -i '/^.*AudioCard.*$/a \\t<string name="AudioDevice" value="'"${AUDIODEVICE}"'" \/>' ${ES_SETTINGS}
  fi
  set_setting system.audiodevice "${AUDIODEVICE}"
}

case ${1} in
  controls)
    get_controls 2>/dev/null
  ;;
  set)
    set_es "$2"
  ;;
  get)
    get_es
  ;;
esac
